# Stock CNN æµ‹è¯•æŠ¥å‘Š

## 1. æµ‹è¯•æ¦‚è¿°

æœ¬æŠ¥å‘Šè®°å½•äº†ä¸‰ç§æ¨¡å‹ï¼ˆBaseline CNNã€Baseline Large CNNã€Vision Transformerï¼‰åœ¨æµ‹è¯•é›†ä¸Šçš„è¡¨ç°ï¼Œä»¥åŠåŸºäºæ¨¡å‹é¢„æµ‹çš„é€‰è‚¡ç­–ç•¥å›æµ‹ç»“æœã€‚

---

## 2. æµ‹è¯•é…ç½®

### 2.1 æµ‹è¯•æ•°æ®
| é¡¹ç›® | è¯´æ˜ |
|------|------|
| æ—¶é—´èŒƒå›´ | 2001å¹´ - 2019å¹´ |
| æ ·æœ¬æ•°é‡ | 1,403,975 |
| å›¾åƒå°ºå¯¸ | 64 Ã— 60 |
| æµ‹è¯•æ‰¹å¤§å° | 2,048 |

### 2.2 æµ‹è¯•æ¨¡å‹
| æ¨¡å‹ | æ¨¡å‹è·¯å¾„ | é€‰è‚¡é˜ˆå€¼ |
|------|----------|----------|
| Baseline | `pt/baseline/best.pt` | 0.58 |
| Baseline Large | `pt/baseline_large/best.pt` | 0.58 |
| ViT | `pt/vit/best.pt` | 0.50 |

> **æ³¨**: ViT æ¨¡å‹ä½¿ç”¨è¾ƒä½é˜ˆå€¼ (0.50)ï¼Œå› ä¸ºå…¶é¢„æµ‹æ¦‚ç‡åˆ†å¸ƒä¸ CNN æ¨¡å‹ä¸åŒã€‚

---

## 3. æ¨¡å‹æ¨ç†ç»“æœ

### 3.1 æµ‹è¯•æŒ‡æ ‡å¯¹æ¯”
| æ¨¡å‹ | å‚æ•°é‡ | æµ‹è¯•æŸå¤± | å‡†ç¡®ç‡ | é€‰è‚¡æ¯”ä¾‹ |
|------|--------|----------|--------|----------|
| **Baseline** | 0.71M | 0.6942 | 51.58% | 1.85% |
| **Baseline Large** | 10.23M | **0.6926** | **52.10%** | 4.47% |
| **ViT** | 10.82M | 0.6935 | 49.84% | 23.27% |

### 3.2 æŒ‡æ ‡è¯´æ˜
- **æµ‹è¯•æŸå¤±**: CrossEntropyLossï¼Œè¶Šä½è¶Šå¥½
- **å‡†ç¡®ç‡**: é¢„æµ‹æ­£ç¡®çš„æ ·æœ¬æ¯”ä¾‹
- **é€‰è‚¡æ¯”ä¾‹**: é¢„æµ‹æ¦‚ç‡è¶…è¿‡é˜ˆå€¼çš„è‚¡ç¥¨å æ¯”

---

## 4. å›æµ‹ç­–ç•¥è®¾è®¡

### 4.1 ç­–ç•¥è¯´æ˜

#### åŸºå‡†ç­–ç•¥ (Buy All)
- æ¯ä¸ªäº¤æ˜“æ—¥ç­‰æƒä¹°å…¥æ‰€æœ‰è‚¡ç¥¨
- æŒæœ‰20ä¸ªäº¤æ˜“æ—¥åå–å‡º
- ä»£è¡¨å¸‚åœºæ•´ä½“è¡¨ç°

#### CNN é€‰è‚¡ç­–ç•¥
- åªä¹°å…¥æ¨¡å‹é¢„æµ‹æ¦‚ç‡ > é˜ˆå€¼çš„è‚¡ç¥¨
- ç­‰æƒé…ç½®é€‰ä¸­çš„è‚¡ç¥¨
- æŒæœ‰20ä¸ªäº¤æ˜“æ—¥åå–å‡º

### 4.2 æ”¶ç›Šè®¡ç®—
```python
# åŸºå‡†æ”¶ç›Šï¼šæ¯æ—¥æ‰€æœ‰è‚¡ç¥¨çš„å¹³å‡æ”¶ç›Š
ret_baseline = label_df.groupby(['Date'])['Ret_20d'].mean()

# ç­–ç•¥æ”¶ç›Šï¼šæ¯æ—¥é€‰ä¸­è‚¡ç¥¨çš„å¹³å‡æ”¶ç›Š
ret_strategy = label_filtered.groupby(['Date'])['Ret_20d'].mean()

# ç´¯è®¡æ”¶ç›Š
cum_return = (ret + 1).cumprod()
```

---

## 5. å›æµ‹ç»“æœ

### 5.1 ç´¯è®¡æ”¶ç›Šå¯¹æ¯”
| æ¨¡å‹ | ç´¯è®¡æ”¶ç›Š | è¶…é¢æ”¶ç›Š | å¹´åŒ–æ”¶ç›Šç‡ |
|------|----------|----------|------------|
| **Baseline** | **19.86x** | **+16.68** | ~17.5% |
| **Baseline Large** | 17.11x | +13.93 | ~16.8% |
| **ViT** | 2.84x | -0.34 | ~5.7% |
| Buy All (åŸºå‡†) | 3.18x | 0 | ~6.3% |

### 5.2 å…³é”®å‘ç°

1. ğŸ† **Baseline CNN è¡¨ç°æœ€ä½³**
   - ç´¯è®¡æ”¶ç›Š 19.86 å€ï¼Œæ˜¯åŸºå‡†çš„ 6.2 å€
   - ä»…é€‰æ‹© 1.85% çš„è‚¡ç¥¨ï¼Œå®ç°è¶…é«˜æ”¶ç›Š

2. ğŸ“Š **Baseline Large æ¬¡ä¼˜**
   - ç´¯è®¡æ”¶ç›Š 17.11 å€
   - é€‰è‚¡æ¯”ä¾‹è¾ƒé«˜ (4.47%)ï¼Œä½†æ”¶ç›Šç•¥ä½

3. âš ï¸ **ViT è¡¨ç°ä¸ä½³**
   - ç´¯è®¡æ”¶ç›Š 2.84 å€ï¼Œä½äºåŸºå‡†
   - é€‰è‚¡æ¯”ä¾‹è¿‡é«˜ (23.27%)ï¼Œé€‰è‚¡èƒ½åŠ›å¼±

### 5.3 é€‰è‚¡æ•°é‡ç»Ÿè®¡
| æ¨¡å‹ | é€‰ä¸­è‚¡ç¥¨æ•° | æ€»è‚¡ç¥¨æ•° | é€‰è‚¡æ¯”ä¾‹ |
|------|------------|----------|----------|
| Baseline | 25,922 | 1,403,975 | 1.85% |
| Baseline Large | 62,823 | 1,403,975 | 4.47% |
| ViT | 326,761 | 1,403,975 | 23.27% |

---

## 6. å¯è§†åŒ–ç»“æœ

### 6.1 ç”Ÿæˆçš„å›¾è¡¨

| å›¾è¡¨ | æ–‡ä»¶è·¯å¾„ | è¯´æ˜ |
|------|----------|------|
| ç»¼åˆå¯¹æ¯”å›¾ | `pic/test_comparison.png` | åŒ…å«ç´¯è®¡æ”¶ç›Šã€å¯¹æ•°æ”¶ç›Šã€è¶…é¢æ”¶ç›Šã€æµ‹è¯•æŒ‡æ ‡ |
| é€‰è‚¡æ•°é‡å›¾ | `pic/stocks_selected.png` | å„æ¨¡å‹æ¯æ—¥é€‰ä¸­è‚¡ç¥¨æ•°é‡å˜åŒ– |

### 6.2 å›¾è¡¨å†…å®¹

**test_comparison.png** åŒ…å« 4 ä¸ªå­å›¾:
1. **ç´¯è®¡æ”¶ç›Šå¯¹æ¯”**: å„æ¨¡å‹ç­–ç•¥ vs åŸºå‡†ç­–ç•¥
2. **å¯¹æ•°ç´¯è®¡æ”¶ç›Š**: æ›´æ¸…æ™°å±•ç¤ºé•¿æœŸè¶‹åŠ¿
3. **è¶…é¢æ”¶ç›Šæ›²çº¿**: ç­–ç•¥ç›¸å¯¹åŸºå‡†çš„è¶…é¢è¡¨ç°
4. **æµ‹è¯•æŒ‡æ ‡æŸ±çŠ¶å›¾**: æµ‹è¯•æŸå¤±å’Œå‡†ç¡®ç‡å¯¹æ¯”

**stocks_selected.png**:
- æ•£ç‚¹å›¾å±•ç¤ºæ¯æ—¥é€‰ä¸­è‚¡ç¥¨æ•°é‡
- å¯è§‚å¯Ÿæ¨¡å‹é€‰è‚¡è¡Œä¸ºçš„æ—¶é—´åˆ†å¸ƒ

---

## 7. æ ¸å¿ƒä»£ç é€»è¾‘

### 7.1 è¯„ä¼°å¾ªç¯
```python
def eval_loop(dataloader, net, loss_fn, model_name="model"):
    running_loss = 0.0
    current = 0
    net.eval()
    
    with torch.no_grad():
        for batch, (X, y) in enumerate(dataloader):
            X, y = X.to(device), y.to(device)
            y_pred = net(X)
            loss = loss_fn(y_pred, y.long())
            
            # åŠ æƒå¹³å‡è®¡ç®— loss
            running_loss = (len(X) * loss.item() + running_loss * current) / (len(X) + current)
            current += len(X)
            
    return running_loss, torch.cat(predict), torch.cat(target)
```

### 7.2 ç­–ç•¥æ”¶ç›Šè®¡ç®—
```python
def calculate_strategy_returns(label_df, predict_logit, threshold=0.58):
    # åŸºå‡†ï¼šä¹°å…¥æ‰€æœ‰è‚¡ç¥¨
    ret_baseline = label_df.groupby(['Date'])['Ret_20d'].mean()
    
    # ç­–ç•¥ï¼šåªä¹°å…¥é¢„æµ‹æ¦‚ç‡ > threshold çš„è‚¡ç¥¨
    mask = predict_logit > threshold
    label_filtered = label_df[mask]
    ret_strategy = label_filtered.groupby(['Date'])['Ret_20d'].mean()
    
    return ret_baseline, ret_strategy
```

---

## 8. æ•°æ®å­—æ®µè¯´æ˜

### 8.1 label_df å­—æ®µ
| å­—æ®µ | è¯´æ˜ |
|------|------|
| Date | äº¤æ˜“æ—¥æœŸ |
| Ret_20d | æœªæ¥20æ—¥æ”¶ç›Šç‡ |
| å…¶ä»– | è‚¡ç¥¨ä»£ç ã€ä»·æ ¼ç­‰ |

### 8.2 ç»“æœå­—å…¸å­—æ®µ
| å­—æ®µ | è¯´æ˜ |
|------|------|
| test_loss | æµ‹è¯•é›†æŸå¤± |
| accuracy | é¢„æµ‹å‡†ç¡®ç‡ |
| threshold | é€‰è‚¡é˜ˆå€¼ |
| num_selected | é€‰ä¸­è‚¡ç¥¨æ•°é‡ |
| selection_ratio | é€‰è‚¡æ¯”ä¾‹ |
| cum_ret_strategy | ç­–ç•¥ç´¯è®¡æ”¶ç›Š |
| excess_return | è¶…é¢æ”¶ç›Š |

---

## 9. ç»“è®ºä¸å»ºè®®

### 9.1 æ¨¡å‹é€‰æ‹©å»ºè®®
| åœºæ™¯ | æ¨èæ¨¡å‹ | åŸå›  |
|------|----------|------|
| ç”Ÿäº§éƒ¨ç½² | Baseline | å‚æ•°å°‘ã€é€Ÿåº¦å¿«ã€æ”¶ç›Šæœ€é«˜ |
| ç ”ç©¶æ¢ç´¢ | Baseline Large | å®¹é‡å¤§ã€å¯è¿›ä¸€æ­¥è°ƒä¼˜ |
| ä¸æ¨è | ViT | æ­¤ä»»åŠ¡ä¸Šè¡¨ç°ä¸ä½³ |

### 9.2 ç­–ç•¥ä¼˜åŒ–æ–¹å‘
1. **é˜ˆå€¼è°ƒä¼˜**: å¯å°è¯•ä¸åŒé˜ˆå€¼å¯»æ‰¾æœ€ä¼˜é€‰è‚¡æ¯”ä¾‹
2. **åŠ æƒé…ç½®**: æ ¹æ®é¢„æµ‹æ¦‚ç‡åŠ æƒé…ç½®ï¼Œè€Œéç­‰æƒ
3. **é£é™©æ§åˆ¶**: åŠ å…¥æ­¢æŸæœºåˆ¶å’Œä»“ä½ç®¡ç†
4. **ç»„åˆç­–ç•¥**: ç»“åˆå¤šä¸ªæ¨¡å‹çš„é¢„æµ‹ç»“æœ

### 9.3 å±€é™æ€§
- æœªè€ƒè™‘äº¤æ˜“æˆæœ¬å’Œæ»‘ç‚¹
- å‡è®¾å¯ä»¥æ— é™åˆ†å‰²ä¹°å…¥ä»»æ„è‚¡ç¥¨
- å†å²å›æµ‹ä¸ä»£è¡¨æœªæ¥è¡¨ç°

---

## 10. å¤ç°æŒ‡å—

### 10.1 è¿è¡Œæµ‹è¯•
```bash
cd notebooks
jupyter notebook test.ipynb
```

### 10.2 è¾“å‡ºæ–‡ä»¶
| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `pt/test_results.json` | æµ‹è¯•ç»“æœ JSON |
| `pic/test_comparison.png` | ç»¼åˆå¯¹æ¯”å›¾ |
| `pic/stocks_selected.png` | é€‰è‚¡æ•°é‡å›¾ |

---

*æŠ¥å‘Šç”Ÿæˆæ—¶é—´: 2025å¹´12æœˆ*
