# Stock CNN 测试报告

## 1. 测试概述

本测试对三种训练好的模型（Baseline、Baseline Large、ViT）进行样本外回测，评估其作为股票选择策略的实际投资表现。测试数据覆盖 2001-2019 年，共 19 年的市场数据。

---

## 2. 测试配置

### 2.1 测试环境

| 配置项 | 设置 |
|--------|------|
| 设备 | GPU (CUDA) |
| Batch Size | 2048 |
| 随机种子 | 42 |

### 2.2 测试数据

| 配置项 | 设置 |
|--------|------|
| 测试年份 | 2001-2019 年 |
| 测试样本数 | 1,403,975 |
| 图像尺寸 | 64 × 60 (H × W) |
| 标签 | 二分类（Ret_20d > 0） |

### 2.3 策略参数

| 参数 | 设置 |
|------|------|
| 选股阈值 (threshold) | 0.58 |
| 持仓周期 | 20 个交易日 |

---

## 3. 测试模型

| 模型 | 参数量 | 模型路径 | 训练 Val Loss |
|------|--------|---------|---------------|
| Baseline | 0.71M | `pt/baseline/best.pt` | 0.6871 |
| Baseline Large | 10.23M | `pt/baseline_large/best.pt` | 0.6864 |
| ViT | 10.82M | `pt/vit/best.pt` | 0.6917 |

---

## 4. 测试结果汇总

### 4.1 模型性能对比

| 模型 | Test Loss | Accuracy | 选股比例 | 累计收益 | 超额收益 |
|------|-----------|----------|----------|----------|----------|
| **Baseline** | 0.6942 | 51.58% | 1.85% | **19.86x** | **+16.68** |
| **Baseline Large** | 0.6926 | 52.10% | 4.47% | 17.11x | +13.93 |
| **ViT** | 0.6935 | 49.84% | 0.00% | 1.00x | -2.18 |
| Baseline (买入全部) | - | - | 100% | 3.18x | 0 |

### 4.2 关键发现

1. **Baseline 模型表现最佳**：
   - 累计收益达到 **19.86 倍**，超额收益 **16.68**
   - 仅选择 1.85% 的股票，但收益远超买入全部股票的基准

2. **Baseline Large 表现良好**：
   - 累计收益 17.11 倍，超额收益 13.93
   - 选股比例较高（4.47%），分散化程度更好

3. **ViT 表现不佳**：
   - 预测概率分布过于保守，阈值 0.58 下无股票被选中
   - 模型未能有效学习到有用的特征

---

## 5. 策略详情

### 5.1 策略说明

模型输出每个股票-日期样本未来 20 天上涨的概率 `predict_logit`，基于此构建投资策略：

| 策略 | 描述 |
|------|------|
| **Baseline (Buy All)** | 买入所有股票，等权重 |
| **Model Strategy** | 只买入 `predict_logit > 0.58` 的股票 |

### 5.2 选股统计

| 模型 | 总样本数 | 选中股票数 | 选股比例 |
|------|----------|-----------|----------|
| Baseline | 1,403,975 | 25,922 | 1.85% |
| Baseline Large | 1,403,975 | 62,823 | 4.47% |
| ViT | 1,403,975 | 0 | 0.00% |

---

## 6. 收益分析

### 6.1 累计收益对比

| 策略 | 2001-2019 累计收益 |
|------|-------------------|
| Baseline (Buy All) | 3.18x |
| Baseline 选股策略 | **19.86x** |
| Baseline Large 选股策略 | 17.11x |
| ViT 选股策略 | 1.00x |

### 6.2 年化收益估算

假设 19 年的投资周期：

| 策略 | 累计收益 | 年化收益 |
|------|----------|----------|
| Baseline (Buy All) | 3.18x | ~6.3% |
| Baseline 选股策略 | 19.86x | ~17.1% |
| Baseline Large 选股策略 | 17.11x | ~16.2% |

---

## 7. 可视化输出

### 7.1 生成的图表

| 图表文件 | 描述 |
|---------|------|
| `pic/test_comparison.png` | 多模型测试结果对比图（4 子图） |
| `pic/stocks_selected.png` | 选中股票数量随时间变化图 |

### 7.2 图表内容

**test_comparison.png** 包含：
1. 累计收益对比（所有模型 vs Baseline）
2. 对数累计收益对比
3. 超额收益曲线
4. Test Loss 和 Accuracy 柱状图

**stocks_selected.png** 显示：
- 每个模型在不同时间点选中的股票数量

---

## 8. 最佳模型分析

### 8.1 Baseline 模型

| 指标 | 值 |
|------|-----|
| 模型类型 | 3 层 CNN |
| 参数量 | 708,866 (0.71M) |
| Test Loss | 0.6942 |
| Accuracy | 51.58% |
| 选股阈值 | 0.58 |
| 选中股票 | 25,922 (1.85%) |
| 累计收益 | 19.86x |
| 超额收益 | +16.68 |

### 8.2 为什么 Baseline 最好？

1. **精准选股**：仅选择 1.85% 的高置信度股票
2. **避免噪声**：较小的模型不容易过拟合
3. **泛化能力强**：在 19 年的样本外数据上表现稳定

---

## 9. 结论与建议

### 9.1 结论

1. **CNN 模型有效**：Baseline 和 Baseline Large 都能产生显著的超额收益。

2. **模型复杂度不是关键**：最简单的 Baseline 模型反而表现最好。

3. **ViT 不适合此任务**：Vision Transformer 在股票图像分类任务上表现不佳。

4. **阈值选择重要**：0.58 的阈值对于 Baseline 效果很好，但对 ViT 过于严格。

### 9.2 建议

1. **生产环境推荐使用 Baseline 模型**
2. **可以尝试不同的阈值进行敏感性分析**
3. **考虑加入交易成本和滑点的影响**
4. **建议进行更多的样本外测试**

---

## 10. 输出文件

| 输出文件 | 路径 |
|---------|------|
| 测试结果 JSON | `pt/test_results.json` |
| 测试对比图 | `pic/test_comparison.png` |
| 选股数量图 | `pic/stocks_selected.png` |

---

## 11. 复现步骤

```bash
# 1. 确保已完成训练
# 2. 运行测试 notebook
cd notebooks
jupyter notebook test.ipynb

# 3. 查看生成的图表
ls ../pic/
```

---

*报告生成时间: 2025-12-02*
